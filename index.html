<script type="module">
  window.onload = function() {
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Section management
    const sections = {
      homeSection: document.getElementById('homeSection'),
      sellSection: document.getElementById('sellSection'),
      buySection: document.getElementById('buySection'),
      mapSection: document.getElementById('mapSection')
    };

    function showSection(sectionId) {
      Object.entries(sections).forEach(([id, element]) => {
        element.style.display = id === sectionId ? 'block' : 'none';
      });
      if (sectionId === 'mapSection') {
        initMap();
      }
    }

    // Navigation
    document.getElementById('homeBtn').addEventListener('click', () => showSection('homeSection'));
    document.getElementById('mapBtn').addEventListener('click', () => showSection('mapSection'));
    document.getElementById('sellBtn').addEventListener('click', () => showSection('sellSection'));
    document.getElementById('buyBtn').addEventListener('click', () => showSection('buySection'));

    // Map initialization
    let map = null;
    function initMap() {
      if (!map) {
        map = new naver.maps.Map('map', {
          center: new naver.maps.LatLng(37.5665, 126.9780), // Seoul
          zoom: 12
        });
      }
    }

    // Form handlers
    document.getElementById('sellForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const data = {
          itemType: document.getElementById('itemType').value,
          price: parseInt(document.getElementById('price').value),
          address: document.getElementById('address').value,
          timestamp: Date.now()
        };
        
        await push(ref(db, '매물'), data);
        alert('매물이 등록되었습니다!');
        e.target.reset();
        showSection('homeSection');
      } catch (error) {
        console.error('Error posting item:', error);
        alert('등록 중 오류가 발생했습니다.');
      }
    });

    document.getElementById('buyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const data = {
          buyType: document.getElementById('buyType').value,
          maxPrice: parseInt(document.getElementById('maxPrice').value),
          buyAddress: document.getElementById('buyAddress').value,
          timestamp: Date.now()
        };
        
        await push(ref(db, '매수자'), data);
        alert('매수 요청이 등록되었습니다!');
        e.target.reset();
        showSection('homeSection');
      } catch (error) {
        console.error('Error posting buy request:', error);
        alert('등록 중 오류가 발생했습니다.');
      }
    });

    // Load recent listings
    function updateRecentListings() {
      const listingsRef = ref(db, '매물');
      onValue(listingsRef, (snapshot) => {
        const listings = snapshot.val();
        const recentListingsDiv = document.getElementById('recentListings');
        recentListingsDiv.innerHTML = '';
        
        if (listings) {
          Object.entries(listings).reverse().slice(0, 5).forEach(([key, data]) => {
            const listingDiv = document.createElement('div');
            // Check for undefined and format
            const price = data.price;
            const formattedPrice = price !== undefined && price !== null ? price.toLocaleString() : 'N/A';
            listingDiv.innerHTML = ` 
              <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
                <h3>${data.itemType}</h3>
                <p>가격: ${formattedPrice}만원</p>
                <p>주소: ${data.address}</p>
              </div>
            `;
            recentListingsDiv.appendChild(listingDiv);
          });
        }
      });
    }

    // Initialize the app
    updateRecentListings();
    showSection('homeSection');
  }
</script>
