<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js';
  import { getDatabase, ref, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js';
  import $ from 'https://code.jquery.com/jquery-3.6.0.min.js';

  const firebaseConfig = {
    apiKey: "AIzaSyB1X2Y9K9-dQBDXQ7eVxaGKJDQc_ztdWYs",
    authDomain: "real-estate-app-7a001.firebaseapp.com",
    databaseURL: "https://real-estate-app-7a001-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "real-estate-app-7a001",
    storageBucket: "real-estate-app-7a001.appspot.com",
    messagingSenderId: "229808061189",
    appId: "1:229808061189:web:fa083511b468b44e3556c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let filterValue = 'all';

  document.getElementById('postTypeFilter').addEventListener('change', (e) => {
    filterValue = e.target.value;
    loadBoardPosts();
  });

  // ğŸ”¹ ì£¼ì†Œ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€ (ë§¤ë„, ë§¤ìˆ˜ ê³µí†µ ì‚¬ìš©)
  function searchAddress(inputId, resultId) {
    let keyword = document.getElementById(inputId).value;
    if (!keyword) {
      alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    let apiKey = "U01TX0FVVEgyMDI1MDEzMDIyMDExMDExNTQzNDc=";
    let apiUrl = `https://www.juso.go.kr/addrlink/addrLinkApiJsonp.do?confmKey=${apiKey}&currentPage=1&countPerPage=5&keyword=${encodeURIComponent(keyword)}&resultType=json`;

    $.ajax({
      url: apiUrl,
      type: "GET",
      dataType: "jsonp",
      crossDomain: true,
      success: function (response) {
        let result = response.results;
        let listDiv = document.getElementById(resultId);
        listDiv.innerHTML = "";

        if (result.common.totalCount === "0") {
          listDiv.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        let ul = document.createElement("ul");
        result.juso.forEach(addr => {
          let li = document.createElement("li");
          li.textContent = addr.roadAddr;
          li.onclick = function () {
            document.getElementById(inputId).value = addr.roadAddr;
            listDiv.innerHTML = "";
          };
          ul.appendChild(li);
        });
        listDiv.appendChild(ul);
      },
      error: function () {
        alert("ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('sellForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sellContentElement = document.getElementById('sellContent');
      if (!sellContentElement) {
        console.error('sellContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        alert('ì˜¤ë¥˜ ë°œìƒ: ë‚´ìš©ì„ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const data = {
        itemType: document.getElementById('itemType').value,
        price: parseInt(document.getElementById('price').value),
        address: document.getElementById('address').value,
        sellerName: document.getElementById('sellerName').value,
        content: sellContentElement.value,
        type: 'sell',
        timestamp: Date.now()
      };
      await push(ref(db, 'ê²Œì‹œíŒ'), data);
      alert('ë§¤ë„ ë¬¼ê±´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
      e.target.reset();
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('buyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const buyContentElement = document.getElementById('BuyContent');
      if (!buyContentElement) {
        console.error('BuyContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        alert('ì˜¤ë¥˜ ë°œìƒ: ë‚´ìš©ì„ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const data = {
        buyType: document.getElementById('buyType').value,
        maxPrice: parseInt(document.getElementById('maxPrice').value),
        buyAddress: document.getElementById('buyAddress').value,
        buyerName: document.getElementById('buyerName').value,
        content: buyContentElement.value,
        type: 'buy',
        timestamp: Date.now()
      };
      await push(ref(db, 'ê²Œì‹œíŒ'), data);
      alert('ë§¤ìˆ˜ ë¬¼ê±´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
      e.target.reset();
    });
  });
</script>

<!-- ë§¤ë„ ë“±ë¡ -->
<section id="sellSection" style="display: none;">
  <h2>ë§¤ë„ ë“±ë¡</h2>
  <form id="sellForm">
    <label for="itemType">ì¢…ë¥˜:</label>
    <input type="text" id="itemType" placeholder="ì˜ˆ: ì•„íŒŒíŠ¸" required>

    <label for="price">ë§¤ë„ê°€ê²© (ë§Œì›):</label>
    <input type="number" id="price" placeholder="ì˜ˆ: 50000" required>

    <label for="address">ì£¼ì†Œ:</label>
    <input type="text" id="address" placeholder="ë„ë¡œëª… ì£¼ì†Œ ì…ë ¥" required>
    <button type="button" onclick="searchAddress('address', 'sellAddressList')">ì£¼ì†Œ ê²€ìƒ‰</button>
    <div id="sellAddressList"></div>

    <label for="sellerName">ì‘ì„±ì ì´ë¦„:</label>
    <input type="text" id="sellerName" placeholder="ì‘ì„±ì ì´ë¦„" required>

    <label>ë‚´ìš©: <textarea id="sellContent" maxlength="1000" required></textarea></label>
    <button type="submit">ë“±ë¡í•˜ê¸°</button>
  </form>
</section>

<!-- ë§¤ìˆ˜ ë“±ë¡ -->
<section id="buySection" style="display: none;">
  <h2>ë§¤ìˆ˜ ë“±ë¡</h2>
  <form id="buyForm">
    <label for="buyType">ì¢…ë¥˜:</label>
    <input type="text" id="buyType" placeholder="ì˜ˆ: ì•„íŒŒíŠ¸" required>

    <label for="maxPrice">ë§¤ìˆ˜ê°€ê²© (ë§Œì›):</label>
    <input type="number" id="maxPrice" placeholder="ì˜ˆ: 50000" required>

    <label for="buyAddress">ì£¼ì†Œ:</label>
    <input type="text" id="buyAddress" placeholder="ë„ë¡œëª… ì£¼ì†Œ ì…ë ¥" required>
    <button type="button" onclick="searchAddress('buyAddress', 'buyAddressList')">ì£¼ì†Œ ê²€ìƒ‰</button>
    <div id="buyAddressList"></div>

    <label for="buyerName">ì‘ì„±ì ì´ë¦„:</label>
    <input type="text" id="buyerName" placeholder="ì‘ì„±ì ì´ë¦„" required>

    <label>ë‚´ìš©: <textarea id="BuyContent" maxlength="1000" required></textarea></label>
    <button type="submit">ë“±ë¡í•˜ê¸°</button>
  </form>
</section>
