<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부동산 PWA</title>

    <!-- 1. Script 태그에 async 제거하고 defer 추가 -->
    <script type="text/javascript" 
            src="https://openapi.naver.com/openapi/v3/maps.js?ncpClientId=g1751tw37y"
            defer></script>

    <!-- 나머지 스타일은 동일하게 유지 -->
    <style>
        /* 기존 스타일 코드 유지 */
    </style>
</head>
<body>
    <!-- 기존 HTML 구조 유지 -->

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js';
        import { getDatabase, ref, push, onValue } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js';

        // Firebase 설정 코드는 동일하게 유지

        // 2. Naver 지도 초기화 함수 수정
        let map = null;
        function initMap() {
            if (!map && window.naver && window.naver.maps) {
                try {
                    map = new naver.maps.Map('map', {
                        center: new naver.maps.LatLng(37.5665, 126.9780),
                        zoom: 12,
                        zoomControl: true,
                        zoomControlOptions: {
                            position: naver.maps.Position.TOP_RIGHT
                        }
                    });

                    // 3. 매물 위치에 마커 표시
                    const listingsRef = ref(db, '매물');
                    onValue(listingsRef, (snapshot) => {
                        const listings = snapshot.val();
                        if (listings) {
                            Object.entries(listings).forEach(([key, data]) => {
                                // 주소를 좌표로 변환하는 지오코딩 예시
                                // 실제로는 Naver Maps Geocoding API를 사용해야 합니다
                                new naver.maps.Marker({
                                    position: new naver.maps.LatLng(37.5665, 126.9780), // 기본 위치
                                    map: map,
                                    title: data.itemType
                                });
                            });
                        }
                    });
                } catch (error) {
                    console.error('지도 초기화 오류:', error);
                    alert('지도를 불러오는데 실패했습니다.');
                }
            } else {
                console.error('Naver Maps API가 로드되지 않았습니다.');
                setTimeout(initMap, 1000); // 1초 후 재시도
            }
        }

        // 4. 지도 버튼 클릭 이벤트 수정
        document.getElementById('mapBtn').addEventListener('click', () => {
            showSection('mapSection');
            // 지도 섹션이 표시된 후 약간의 지연을 두고 초기화
            setTimeout(initMap, 100);
        });

        // 나머지 코드는 동일하게 유지
    </script>
</body>
</html>